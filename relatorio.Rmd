---
title: "Relatorio"
author: "Fabio Firanzi, Heitor Dias, Julia Fideles, Matheus Soares, Tiago Braga"
date: "2025-11-11"
output:
  pdf_document:
    latex_engine: pdflatex
    fig_crop: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo     = FALSE,
  message  = FALSE,
  warning  = FALSE,
  fig.pos  = "H",
  fig.path = "relatorio-figs/",
  crop = FALSE,
  fig.crop = FALSE,   # evita pdfcrop/ghostscript
  dev      = "pdf"    # usa o dispositivo PDF base (independe de X11/Cairo)
)

try(
  unlink(
    list.files("relatorio-figs",
               pattern = "^(reg|grafico|hist).*\\.(pdf|png)$",
               full.names = TRUE),
    force = TRUE
  ),
  silent = TRUE
)
```

```{r setup-e-carga, message=FALSE, warning=FALSE}
library(ggplot2)
library(kableExtra)
library(dplyr)
library(tidyr)

amostra_10p <- read.csv("amostra_10p.csv", fileEncoding = "latin1")
```

<!-- Língua Estrangeira -->
\noindent
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Tabela 1:} Frequência - Escolha da Língua Estrangeira
\par\vspace{1ex}
{\footnotesize
```{r tabela-linguaEstrangeira, results='asis'}
freq_abs_le <- table(amostra_10p$TP_LINGUA)
freq_rel_le <- prop.table(freq_abs_le)
names(freq_abs_le) <- c("Inglês", "Espanhol")

tabela_freq_le <- data.frame(
  'Língua Estrangeira' = names(freq_abs_le),
  Percentual = paste0(round(100 * as.vector(freq_rel_le), 2), "%"),
  Frequência = round(as.vector(freq_abs_le), 4),
  check.names = FALSE
)

tab <- knitr::kable(
  tabela_freq_le,
  format    = "latex",
  booktabs  = TRUE,
  longtable = FALSE
)

cat(tab)
```
}
\end{minipage}
\hfill
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Gráfico 1:} Escolha da Língua Estrangeira
\par\vspace{1ex}

```{r grafico-linguaEstrangeira, out.width = "\\linewidth", fig.asp = 1}
percent_le <- paste0(round(100 * as.vector(freq_rel_le), 2))
rotulo_le <- paste(names(freq_abs_le), " (", percent_le, "%)", sep="")

pie(freq_abs_le,
    main = "Língua Estrangeira Selecionada",
    col = c("#FA6496", "#99005C"),
    labels = rotulo_le
)
```
\end{minipage}

\vfill


<!-- AUXILIAR: Categoria de Tipo da Redação (Zerada ou Não Zerada) -->

```{r statusRedacao}
amostra_10p$TP_REDACAO <- ifelse(
  amostra_10p$TP_STATUS_REDACAO == 1,
  "0", # Não Zerada
  "1" # Zerada
)
```

<!-- Redações zeradas -->
\noindent
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Tabela 2:} Frequência - Motivo do Zero na Redação
\par\vspace{1ex}
{\footnotesize
```{r tabela-motivoZero, results='asis'}
# Tabela de motivos para o zero na redação
redacoes_zeradas <- amostra_10p %>% filter(TP_STATUS_REDACAO >= 2 & TP_STATUS_REDACAO <= 9)
redacoes_zeradas <- redacoes_zeradas %>% select(TP_STATUS_REDACAO)


freq_abs_red_zero <- table(redacoes_zeradas)
freq_rel_red_zero <- prop.table(freq_abs_red_zero)
names(freq_abs_red_zero) <- c("Anulada", "Cópia Texto Motivador", "Em Branco", "Fuga ao Tema", "Não atendimento ao tipo textual", "Texto insuficiente", "Parte desconectada")

tabela_motivo_zero <- data.frame(
  Motivo = names(freq_abs_red_zero),
  Percentual = paste0(round(100 * as.vector(freq_rel_red_zero), 2), "%"),
  check.names = FALSE
)

tab <- knitr::kable(
  tabela_motivo_zero,
  format    = "latex",
  booktabs  = TRUE,
  longtable = FALSE
)

cat(tab)
```
}
\end{minipage}
\hfill
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Gráfico 2:} Motivos para Redação Zerada
\par\vspace{1ex}

```{r grafico-motivoZero, out.width = "\\linewidth", fig.asp = 0.8, fig.width = 10, fig.height = 8}
percent_zero <- paste0(round(100 * as.vector(freq_rel_red_zero), 2))
rotulo_zero <- paste(names(freq_abs_red_zero), " (", percent_zero, "%)", sep="")

pie(freq_abs_red_zero,
    main = "Redações Zeradas - Motivo",
    col = c("#B87AAD", "#B5599D", "#B13991", "#AD1186", "#8A1189", "#6F1189", "#4A117B"),
    labels = rotulo_zero
)
```
\end{minipage}

\vfill


<!-- AUXILIAR: Tabela de específica pra redação, com filtro para redações não zeradas -->

```{r tabela-redacao}
amostra_redacao <- amostra_10p %>%
  select(
    NU_NOTA_COMP1,
    NU_NOTA_COMP2,
    NU_NOTA_COMP3,
    NU_NOTA_COMP4,
    NU_NOTA_COMP5,
    NU_NOTA_REDACAO,
    TP_STATUS_REDACAO,
    TP_REDACAO
  )

amostra_redacao <- amostra_redacao %>%
  filter(TP_REDACAO == 0)
```

<!-- Redações Não Zeradas -->
\noindent
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Tabela 3:} Frequência - Notas nas Competências
\par\vspace{1ex}
{\footnotesize
```{r tabela-notaCompetencias, results='asis'}
# Padronização de linhas
notas <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

freq_abs_comp1 <- table(amostra_redacao$NU_NOTA_COMP1)
freq_rel_comp1 <- prop.table(freq_abs_comp1)

comp2 <- factor(amostra_redacao$NU_NOTA_COMP2, levels = notas)
freq_abs_comp2 <- table(comp2)
freq_rel_comp2 <- prop.table(freq_abs_comp2)

freq_abs_comp3 <- table(amostra_redacao$NU_NOTA_COMP3)
freq_rel_comp3 <- prop.table(freq_abs_comp3)

freq_abs_comp4 <- table(amostra_redacao$NU_NOTA_COMP4)
freq_rel_comp4 <- prop.table(freq_abs_comp4)

freq_abs_comp5 <- table(amostra_redacao$NU_NOTA_COMP5)
freq_rel_comp5 <- prop.table(freq_abs_comp5)

tabela_freq_comp <- data.frame(
  Nota = names(freq_abs_comp1),
  'Comp 1' = paste0(round(100 * as.vector(freq_rel_comp1), 2), "%"),
  'Comp 2' = paste0(round(100 * as.vector(freq_rel_comp2), 2), "%"),
  'Comp 3' = paste0(round(100 * as.vector(freq_rel_comp3), 2), "%"),
  'Comp 4' = paste0(round(100 * as.vector(freq_rel_comp4), 2), "%"),
  'Comp 5' = paste0(round(100 * as.vector(freq_rel_comp5), 2), "%"),
  check.names = FALSE
)

tab <- knitr::kable(
  tabela_freq_comp,
  format    = "latex",
  booktabs  = TRUE,
  longtable = FALSE
)

cat(tab)
```
}
\end{minipage}
\hfill
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Gráfico 3:} Distribuição das Notas por Competência
\par\vspace{1ex}

```{r boxplot-notaCompetencias, out.width="\\linewidth"}
df_long_comp <- amostra_redacao %>%
  select(starts_with("NU_NOTA_COMP")) %>%
  
  pivot_longer(
    cols = everything(),
    names_to = "Competencia",
    values_to = "Nota"
  ) %>%
  
  na.omit()

df_long_comp$Competencia <- gsub("NU_NOTA_", "", df_long_comp$Competencia)

ggplot(
  df_long_comp, aes(x = Competencia, y = Nota, fill = Competencia)
  ) +
  
  geom_boxplot() +
  
  scale_fill_manual(
    values = c(
      "COMP1" = "#CFDCE8",
      "COMP2" = "#97ACC9",
      "COMP3" = "#586FA3",
      "COMP4" = "#203175",
      "COMP5" = "#0E134A"
    )
  ) + 
  
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "white") +
  
  scale_y_continuous(breaks = seq(0, 200, by = 20)) +
  
  labs(
    x = "Competência",
    y = "Nota (0 a 200)",
    fill = "Competência"
  ) +
  
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```
\end{minipage}

\vfill


\noindent
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Tabela 4:} Frequência - Notas da Redação
\par\vspace{1ex}
{\footnotesize
```{r tabela-notaRedacao, results='asis'}
grupos_red <- seq(0, 1000, by = 100)
grupo_notas_red <- cut(
  amostra_redacao$NU_NOTA_REDACAO,
  breaks = grupos_red,
  include.lowest = TRUE,
  right = TRUE
)

freq_abs_red <- table(grupo_notas_red)
freq_rel_red <- prop.table(freq_abs_red)

dados_red <- amostra_redacao$NU_NOTA_REDACAO
media_red <- mean(dados_red, na.rm = TRUE)
sd_red <- sd(dados_red, na.rm = TRUE)

tabela_freq_red <- data.frame(
  'Intervalo de Notas' = names(freq_abs_red),
  Percentual = paste0(round(100 * as.vector(freq_rel_red), 2), "%"),
  check.names = FALSE
)

tab <- knitr::kable(
  tabela_freq_red,
  format    = "latex",
  booktabs  = TRUE,
  longtable = FALSE
)

cat(tab)
```
}
\par\vspace{1ex}
\centering
\footnotesize
Média das notas: `r sprintf("%.2f", media_red)` \\
Desvio Padrão: `r sprintf("%.2f", sd_red)`
\end{minipage}
\hfill
\begin{minipage}[t]{0.48\textwidth}
\centering
\textbf{Gráfico 4:} Distribuição das Notas da Redação
\par\vspace{1ex}

```{r histograma-notaRedacao, out.width="\\linewidth"}
ggplot(amostra_redacao, aes(x = NU_NOTA_REDACAO)) +
  geom_histogram(
    aes(y = after_stat(density)),
    binwidth = 100,
    boundary = 0,
    fill = "#97ACC9",
    color = "white",
    alpha = 0.7
  ) +
  
  stat_function(
    fun = dnorm, 
    args = list(mean = media_red, sd = sd_red),
    color = "#0E134A",
    linewidth = 1.2
  ) +
  
  labs(
    x = "Nota da Redação",
    y = "Frequência Relativa"
  ) +
  
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```
\end{minipage}

\vfill